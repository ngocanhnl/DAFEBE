extends ../../layouts/default.pug

block main
  h1(class="mb-4") Quản lý người dùng

  .card.mb-3
    .card-header Danh sách người dùng
    .card-body
      .row
        .col-8
        .col-4.text-right
          a(
            href=`/${prefixAdmin}/users/create`
            class="btn btn-outline-success"
          ) + Thêm mới

      table(
        class="table table-hover table-sm"
      )
        thead
          tr
            th STT
            th Avatar
            th Họ tên
            th Email
            th Số điện thoại
            th Trạng thái
            th Trạng thái online
            th Ngày tạo
            th Hành động

        tbody
          each item, index in records
            tr 
              td #{index+1}
              td
                if item.avatar
                  img(
                    src=item.avatar
                    alt=item.fullName
                    width="50px"
                    height="50px"
                    style="border-radius: 50%; object-fit: cover;"
                  )
                else
                  .bg-secondary.text-white.rounded-circle.d-flex.align-items-center.justify-content-center(
                    style="width: 50px; height: 50px;"
                  )
                    i.fas.fa-user
              td #{item.fullName}
              td #{item.email}
              td #{item.phone || 'Chưa cập nhật'}
              td
                if (item.status === "active")
                  span.badge.badge-success Hoạt động
                else
                  span.badge.badge-danger Dừng hoạt động
              td
                if (item.statusOnline === "online")
                  span.badge.badge-success Online
                else
                  span.badge.badge-secondary Offline
              td #{moment(item.createdAt).format("DD/MM/YYYY")}
              td
                a(
                  class="btn btn-info btn-sm"
                  href=`/${prefixAdmin}/users/detail/${item.id}`
                ) Chi tiết
                a(
                  class="btn btn-warning btn-sm ml-1"
                  href=`/${prefixAdmin}/users/edit/${item.id}`
                ) Sửa
                button(
                  class="btn btn-danger btn-sm ml-1"
                  data-id=item.id
                  onclick="deleteUser(this)"
                ) Xóa
                if (item.status === "active")
                  button(
                    class="btn btn-secondary btn-sm ml-1"
                    onclick=`changeStatus('${item.id}', 'inactive')`
                  ) Khóa
                else
                  button(
                    class="btn btn-success btn-sm ml-1"
                    onclick=`changeStatus('${item.id}', 'active')`
                  ) Mở khóa

  script.
    function deleteUser(button) {
      if (confirm('Bạn có chắc chắn muốn xóa người dùng này?')) {
        const userId = button.getAttribute('data-id');
        fetch(`/${prefixAdmin}/users/delete/${userId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(() => {
          window.location.reload();
        }).catch(error => {
          console.error('Error:', error);
          alert('Có lỗi xảy ra khi xóa người dùng!');
        });
      }
    }

    function changeStatus(userId, status) {
      const action = status === 'active' ? 'mở khóa' : 'khóa';
      if (confirm(`Bạn có chắc chắn muốn ${action} người dùng này?`)) {
        fetch(`/${prefixAdmin}/users/change-status/${userId}/${status}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(() => {
          window.location.reload();
        }).catch(error => {
          console.error('Error:', error);
          alert('Có lỗi xảy ra khi cập nhật trạng thái!');
        });
      }
    }
