extends ../../layouts/default

block main
  h1.mb-4 Quản lý đăng ký khóa học

  .card
    .card-header
      .d-flex.justify-content-between.align-items-center
        h5.mb-0 Danh sách đăng ký
        .d-flex
          a.btn.btn-primary.mr-2(href=`/${prefixAdmin}/enrollments/transfer-requests`) 
            i.fas.fa-exchange-alt.mr-1
            | Yêu cầu chuyển lớp
          select#statusFilter.form-control.mr-2
            option(value="") Tất cả trạng thái
            option(value="pending") Chờ duyệt
            option(value="approved") Đã duyệt
            option(value="rejected") Đã từ chối
            option(value="cancelled") Đã hủy
            option(value="completed") Hoàn thành
          select#classFilter.form-control
            option(value="") Tất cả lớp học
            each classItem in classes
              option(value=classItem._id)= classItem.class_name

    .card-body
      if enrollments && enrollments.length > 0
        .table-responsive
          table.table.table-striped
            thead
              tr
                th Học viên
                th Lớp học
                th Ngày đăng ký
                th Trạng thái
                th Trạng thái thanh toán
                th Thao tác
            tbody
              each enrollment in enrollments
                tr
                  td
                    strong= enrollment.student_id.fullName
                    br
                    small.text-muted= enrollment.student_id.email
                    if enrollment.student_id.phone
                      br
                      small.text-muted= enrollment.student_id.phone
                  td
                    strong= enrollment.class_id.class_name
                    br
                    small.text-muted= enrollment.class_id.status
                    br
                    small.text-muted= `Từ ${moment(enrollment.class_id.start_date).format('DD/MM/YYYY')} đến ${moment(enrollment.class_id.end_date).format('DD/MM/YYYY')}`
                  td
                    span= moment(enrollment.enrollment_date).format('DD/MM/YYYY HH:mm')
                  td
                    if enrollment.status === 'pending'
                      span.badge.badge-warning Chờ duyệt
                    else if enrollment.status === 'approved'
                      span.badge.badge-success Đã duyệt
                    else if enrollment.status === 'rejected'
                      span.badge.badge-danger Đã từ chối
                    else if enrollment.status === 'cancelled'
                      span.badge.badge-secondary Đã hủy
                    else if enrollment.status === 'completed'
                      span.badge.badge-info Hoàn thành
                  td
                    if enrollment.payment_status === 'pending'
                      span.badge.badge-warning Chờ thanh toán
                    else if enrollment.payment_status === 'paid'
                      span.badge.badge-success Đã thanh toán
                    else if enrollment.payment_status === 'refunded'
                      span.badge.badge-info Đã hoàn tiền
                  td
                    .btn-group
                      a.btn.btn-sm.btn-info(href=`/${prefixAdmin}/enrollments/detail/${enrollment._id}`) Chi tiết
                      if enrollment.status === 'pending'
                        button.btn.btn-sm.btn-success.approve-btn(data-id=enrollment._id) Duyệt
                        button.btn.btn-sm.btn-danger.reject-btn(data-id=enrollment._id) Từ chối
      else
        .alert.alert-info Không có đăng ký nào

      if pagination && pagination.totalPages > 1
        +pagination(pagination)


  script.
    document.addEventListener('DOMContentLoaded', function() {
      // Filter theo status
      const statusFilter = document.getElementById('statusFilter');
      statusFilter.addEventListener('change', function() {
        const status = this.value;
        const currentUrl = new URL(window.location);
        if (status) {
          currentUrl.searchParams.set('status', status);
        } else {
          currentUrl.searchParams.delete('status');
        }
        window.location.href = currentUrl.toString();
      });

      // Filter theo class
      const classFilter = document.getElementById('classFilter');
      classFilter.addEventListener('change', function() {
        const classId = this.value;
        const currentUrl = new URL(window.location);
        if (classId) {
          currentUrl.searchParams.set('class_id', classId);
        } else {
          currentUrl.searchParams.delete('class_id');
        }
        window.location.href = currentUrl.toString();
      });

      // Set giá trị filter hiện tại
      const urlParams = new URLSearchParams(window.location.search);
      const currentStatus = urlParams.get('status');
      const currentClassId = urlParams.get('class_id');

      if (currentStatus) {
        statusFilter.value = currentStatus;
      }
      if (currentClassId) {
        classFilter.value = currentClassId;
      }

      // Xử lý nút duyệt/từ chối
      document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const enrollmentId = this.getAttribute('data-id');
          if (confirm('Bạn có chắc chắn muốn duyệt đăng ký này?')) {
            fetch(`/admin/enrollments/${enrollmentId}/approve`, {
              method: 'PATCH'
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('Đã duyệt đăng ký thành công');
                window.location.reload();
              } else {
                alert('Lỗi: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Có lỗi xảy ra');
            });
          }
        });
      });

      document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const enrollmentId = this.getAttribute('data-id');
          if (confirm('Bạn có chắc chắn muốn từ chối đăng ký này?')) {
            fetch(`/admin/enrollments/${enrollmentId}/reject`, {
              method: 'PATCH'
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('Đã từ chối đăng ký');
                window.location.reload();
              } else {
                alert('Lỗi: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Có lỗi xảy ra');
            });
          }
        });
      });
    }); 